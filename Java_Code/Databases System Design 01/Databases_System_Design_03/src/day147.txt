1ï¸âƒ£ What is a CTE (Common Table Expression)?

Think of a CTE as a temporary named result set that exists only for one query.

WITH cte_name AS (
    SELECT ...
)
SELECT * FROM cte_name;


ğŸ§  Mental model:

â€œRun this subquery first, give it a name, then Iâ€™ll query it like a table.â€

Why we use CTEs:

Cleaner than nested subqueries

Easier to debug

Reusable inside the same query

Required for recursion

2ï¸âƒ£ Multiple (Non-Recursive) CTEs â€” Your First Example

Your query:

WITH dept_sales AS (
    SELECT department, SUM(salary) total_salary
    FROM employees
    GROUP BY department
),
avg_salary AS (
    SELECT AVG(total_salary) avg_sal
    FROM dept_sales
)
SELECT *
FROM dept_sales
WHERE total_salary > (SELECT avg_sal FROM avg_salary);

Whatâ€™s happening step by step:

1ï¸âƒ£ dept_sales

SELECT department, SUM(salary)
FROM employees
GROUP BY department;


â¡ï¸ Creates one row per department.

2ï¸âƒ£ avg_salary

SELECT AVG(total_salary)
FROM dept_sales;


â¡ï¸ Uses the first CTE (important!)
â¡ï¸ Calculates the average department salary

3ï¸âƒ£ Final SELECT

SELECT *
FROM dept_sales
WHERE total_salary > avg_sal;


â¡ï¸ Shows departments that pay above average

ğŸ’¡ Key idea:

CTEs can build on each other, top to bottom.

3ï¸âƒ£ When SHOULD you use multiple CTEs?

Use them when:

Each step answers a different question

You want readable â€œlogic blocksâ€

Youâ€™d otherwise have nested subqueries

Bad:

SELECT *
FROM (
    SELECT department, SUM(salary)
    FROM employees
    GROUP BY department
) t
WHERE ...


Good (CTE):

WITH dept_sales AS (...)
SELECT ...

4ï¸âƒ£ Recursive CTEs (This is the ğŸ”¥ part)

Recursive CTEs are for data that refers to itself.

Examples:

Employees â†’ Managers

Categories â†’ Parent categories

Folder structures

Comments / replies

5ï¸âƒ£ Structure of a Recursive CTE (Very Important)
WITH RECURSIVE cte_name AS (

    -- 1ï¸âƒ£ Anchor query (starting point)
    SELECT ...

    UNION ALL

    -- 2ï¸âƒ£ Recursive query (repeats)
    SELECT ...
    FROM table
    JOIN cte_name ON condition
)
SELECT * FROM cte_name;


ğŸ§  Think:

Anchor = root

Recursive = â€œfind the next levelâ€

Stops automatically when no new rows are found

6ï¸âƒ£ Understanding Your Recursive Example
WITH RECURSIVE emp_hierarchy AS (
    SELECT id, name, manager_id
    FROM employees
    WHERE manager_id IS NULL   -- ğŸ‘ˆ CEO / top boss

    UNION ALL

    SELECT e.id, e.name, e.manager_id
    FROM employees e
    JOIN emp_hierarchy eh ON e.manager_id = eh.id
)
SELECT * FROM emp_hierarchy;

Step-by-step:
1ï¸âƒ£ Anchor Query
WHERE manager_id IS NULL


â¡ï¸ Finds top-level employees (CEO)

2ï¸âƒ£ Recursive Query
JOIN emp_hierarchy eh ON e.manager_id = eh.id


â¡ï¸ Finds employees whose manager is already in the result
â¡ï¸ Repeats until no more matches

ğŸ“Œ Final result:

CEO
 â”œâ”€â”€ Manager A
 â”‚    â”œâ”€â”€ Employee 1
 â”‚    â””â”€â”€ Employee 2
 â””â”€â”€ Manager B
      â””â”€â”€ Employee 3

7ï¸âƒ£ Add LEVEL / DEPTH (Very Common Interview Question)
WITH RECURSIVE emp_hierarchy AS (
    SELECT id, name, manager_id, 1 AS level
    FROM employees
    WHERE manager_id IS NULL

    UNION ALL

    SELECT e.id, e.name, e.manager_id, eh.level + 1
    FROM employees e
    JOIN emp_hierarchy eh ON e.manager_id = eh.id
)
SELECT * FROM emp_hierarchy;


Now you can:

Indent hierarchy

Filter by level

Sort properly

8ï¸âƒ£ Practice Tasks (Do These ğŸ‘‡)
ğŸ§ª Task 1 (Easy)

List departments whose total salary is below average.

ğŸ§ª Task 2 (Medium)

Show employee name + manager name using a recursive CTE.

ğŸ§ª Task 3 (Hard / Interview)

Find the full reporting chain for one employee (employee â†’ CEO).

9ï¸âƒ£ Databases That Support Recursive CTEs

âœ… PostgreSQL
âœ… MySQL 8+
âœ… SQL Server
âœ… Oracle


------------------------------------------------Basic Simple Practice Query --------------------------------


WITH RECURSIVE cte_name AS (

    SELECT
        customerNumber,
        customerName
    FROM customers
    WHERE customerNumber = (
        SELECT MIN(customerNumber) FROM customers
    )

    UNION ALL

    SELECT
        c.customerNumber,
        c.customerName
    FROM customers c
    JOIN cte_name r
        ON c.customerNumber = r.customerNumber + 1
    WHERE c.customerNumber < 500
)

SELECT *
FROM cte_name;




//Example of Level

WITH RECURSIVE customer_hierarchy AS (

    SELECT
        customerNumber,
        customerName,
        parentCustomerNumber,
        1 AS level
    FROM customers
    WHERE parentCustomerNumber IS NULL

    UNION ALL

    SELECT
        c.customerNumber,
        c.customerName,
        c.parentCustomerNumber,
        ch.level + 1 AS level
    FROM customers c
    JOIN customer_hierarchy ch
        ON c.parentCustomerNumber = ch.customerNumber
)

SELECT *
FROM customer_hierarchy
ORDER BY level, customerNumber;



